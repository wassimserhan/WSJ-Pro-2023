'use strict';

var carousel = jQuery('.carousel').flickity({
  fullscreen: true, lazyLoad: 2, autoPlay: 7000, cellAlign: "left", contain: true, initialIndex: 0, dragThreshold: 10, adaptiveHeight: true, groupCells: 2,
  arrowShape: {
    x0: 10,
    x1: 60, y1: 45,
    x2: 60, y2: 45,
    x3: 60
  }
});

var flkty = carousel.data('flickity');

// This form code below creates a alternative select tags where you can add css to the option tag.
// Iterate over each select element
var formIndustry, formState, formCountry, formJobfunction;
jQuery('select').each(function () {
  // Cache the number of options
  var jQuerythis = jQuery(this),
      numberOfOptions = jQuery(this).children('option').length;

  // Hides the select element
  jQuerythis.addClass('s-hidden');

  // Wrap the select element in a div
  jQuerythis.wrap('<div class="select"></div>');

  // Insert a styled div to sit over the top of the hidden select element
  jQuerythis.after('<div class="styledSelect"></div>');

  // Cache the styled div
  var jQuerystyledSelect = jQuerythis.next('div.styledSelect');

  // Show the first select option in the styled div
  jQuerystyledSelect.text(jQuerythis.children('option').eq(0).text());

  // Insert an unordered list after the styled div and also cache the list
  var jQuerylist = jQuery('<ul />', {
    class: 'options'
  }).insertAfter(jQuerystyledSelect);

  // Insert a list item into the unordered list for each select option
  for (var i = 0; i < numberOfOptions; i++) {
    if (i > 0) {
      jQuery('<li />', {
        text: jQuerythis.children('option').eq(i).text().toLowerCase(),
        rel: jQuerythis.children('option').eq(i).data('type'),
        'data-filter': jQuerythis.children('option').eq(i).data('filter')
      }).appendTo(jQuerylist);
    }
  }

  // Cache the list items
  var jQuerylistItems = jQuerylist.children('li');

  // Show the unordered list when the styled div is clicked (also hides it if the div is clicked again)
  jQuerystyledSelect.click(function (e) {
    e.stopPropagation();
    jQuery('div.styledSelect.active').each(function () {
      jQuery(this).removeClass('active').next('ul.options').hide();
    });
    jQuery(this).toggleClass('active').next('ul.options').toggle();
  });

  // Hides the unordered list when a list item is clicked and updates the styled div to show the selected list item
  // Updates the select element to have the value of the equivalent option
  jQuerylistItems.click(function (e) {
    e.stopPropagation();
    jQuerystyledSelect.text(jQuery(this).text()).removeClass('active');
    jQuerythis.val(jQuery(this).attr('rel'));

    var selectType = jQuery(this).attr('rel');
    if (selectType == 'country') {
      formCountry = jQuery(this).text();

      if (jQuery('.state-form-field').hasClass('always-hide')) {
        jQuery('.state-form-field').removeClass('always-hide');
      }

      if (formCountry.toLowerCase() == 'united states') {
        jQuery('li[data-filter="united states"]').show();
        jQuery('li[data-filter="canada"]').hide();

        document.getElementById('field100').checked = true;
      } else if (formCountry.toLowerCase() == 'canada') {
        jQuery('li[data-filter="united states"]').hide();
        jQuery('li[data-filter="canada"]').show();
      } else {
        jQuery('.state-form-field').addClass('always-hide');

        document.getElementById('field100').checked = false;
      }

      // Alternative check for 2nd form
      if (formCountry.toLowerCase() == 'united states') {
        jQuery('li[data-filter="united states"]').show();
        jQuery('li[data-filter="canada"]').hide();

        document.getElementById('field1002').checked = true;
      } else if (formCountry.toLowerCase() == 'canada') {
        jQuery('li[data-filter="united states"]').hide();
        jQuery('li[data-filter="canada"]').show();
      } else {
        jQuery('.state-form-field').addClass('always-hide');

        document.getElementById('field1002').checked = false;
      }
    } else if (selectType == 'state') {
      formState = jQuery(this).text();
    } else if (selectType == 'industry') {
      formIndustry = jQuery(this).text();
    } else if (selectType == 'jobFunction') {
      formJobfunction = jQuery(this).text();
    }

    jQuerylist.hide();
    /* alert(jQuerythis.val()); Uncomment this for demonstration! */
  });

  // Hides the unordered list when clicking outside of it
  jQuery(document).click(function () {
    jQuerystyledSelect.removeClass('active');
    jQuerylist.hide();
  });
});

//Tags

if (document.getElementById('utm_medium')) {
  var getParameterByName = function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, '\\$&');
    var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, ' '));
  };

  document.getElementById('utm_medium').value = getParameterByName('utm_medium');
  document.getElementById('utm_source').value = getParameterByName('utm_source');
  document.getElementById('utm_campaign').value = getParameterByName('utm_campaign');
  document.getElementById('utm_term').value = getParameterByName('utm_term');
  document.getElementById('utm_content').value = getParameterByName('utm_content');

  document.getElementById('SFDCCampaignId').value = getParameterByName('CID') ? getParameterByName('CID') : '';

  document.getElementById('referrerURL').value = window.location.href;
}

//Form modal

var allPricingButtons = document.querySelectorAll('.btn--pricing');
var thirdPricingButton = allPricingButtons[2];
var modal_container = document.getElementById('form__modal-container');
var close = document.getElementById('form__modal-close');

// var jQuerythis = jQuery('select'),
//   numberOfOptions = jQuery('select').children('option').length;

// var jQuerystyledSelect = jQuerythis.next('div.styledSelect');

if (thirdPricingButton) {
  var closeModal = function closeModal() {
    modal_container.classList.remove('form__show');
    body.style.overflow = 'auto';
    document.getElementById('form1').reset();
    document.getElementById('form2').reset();
    // jQuerystyledSelect.text(jQuerythis.children('option').eq(0).text());
  };

  thirdPricingButton.addEventListener('click', function () {
    modal_container.classList.add('form__show');
    body.style.overflow = 'hidden';
    //resets optin
    document.getElementById('field100').checked = false;
  });

  close.addEventListener('click', closeModal);
}

//Form Modal for form-module

var formModalBTN = document.getElementById('formModal');
var formModule_modal_container = document.getElementById('layout-with-form__modal-container');
var formModule_close = document.getElementById('layout-with-form__modal-close');

if (formModalBTN) {
  var _closeModal = function _closeModal() {
    formModule_modal_container.classList.remove('layout-with-form__show');
    body.style.overflow = 'auto';
  };

  formModalBTN.addEventListener('click', function () {
    formModule_modal_container.classList.add('layout-with-form__show');
    body.style.overflow = 'hidden';
    //resets optin
    document.getElementById('field1002').checked = false;
  });

  formModule_close.addEventListener('click', _closeModal);
}

//Form Modal for popup

if (!Cookies.get('popup')) {
  setTimeout(function () {
    jQuery('.popup-overlay').css('display', 'block');
    Cookies.set('popup', 'active', {
      expires: 30,
      path: window.location.pathname
    });
  }, 10000);
}

jQuery('.popup-close, .btn--popup').click(function () {
  jQuery('.popup').hide();
  jQuery('.popup-overlay').css({
    'background-color': 'transparent',
    'z-index': '-99'
  });
});

var popupButton = document.querySelectorAll('.btn--popup');

for (var i = 0, len = popupButton.length; i < len; i++) {
  if (popupButton[i] &&
  // popupButton[i].dataset.name === 'privateequity' &&
  popupButton[i].dataset.action === 'form') {
    var _closeModal2 = function _closeModal2() {
      formModule_modal_container.classList.remove('layout-with-form__show');
      body.style.overflow = 'auto';
    };

    // Opens form modal
    popupButton[i].addEventListener('click', function () {
      formModule_modal_container.classList.add('layout-with-form__show');
      body.style.overflow = 'hidden';
    });
    if (formModule_close) {
      formModule_close.addEventListener('click', _closeModal2);
    }
  } else if (popupButton[i] &&
  // popupButton[i].dataset.name === 'privateequity' &&
  popupButton[i].dataset.action === 'pricing') {
    // Scrolls to pricing module
    popupButton[i].addEventListener('click', function () {
      document.getElementById('pricing').scrollIntoView({ behavior: 'smooth' });
    });
  } else if (popupButton[i]) {
    popupButton[i].addEventListener('click', function () {
      window.open = popupButton[i].dataset.url;
    });
  }
}

var $ = jQuery;

$(window).on('load', function () {
  var emailAddress = '';
  // Production API below
  var newsletterUrl = 'http://www.s.dev.wsj.com/newsletters/svc/signup/2';
  // Below local testing API, Ghost www.premiumnewsletters.wsj.com under /etc/hosts and then gulp this under www.premiumnewsletters.wsj.com:3000/ (reach out to thowfeeq in dowjones if you need anything regarding API or need login credentials for QA reach out to @subashini.balagangatharan in slack)
  // var newsletterUrl = "http://www.s.dev.wsj.com/newsletters/svc/signup/2";

  //   getEmailAddress();

  // $(document).on('click', '.btn-products', function () {

  // })
  $('.btn--products-sign').click(function () {
    var dynamicUrl = $(this).data('name');
    // var subscribed = $(this).html();
    if (emailAddress) {
      // if (subscribed != 'SUBSCRIBED') {
      setTimeout(function () {
        $.ajax({
          type: 'POST',
          dataType: 'json',
          url: newsletterUrl,
          headers: {
            'X-HTTP-Method-Override': 'PATCH',
            'Content-Type': 'application/json'
          },
          data: '{"email": "' + emailAddress + '", "subscription":{"197":true}}',
          xhrFields: {
            withCredentials: true
          },
          crossDomain: true,
          success: function success(data) {},
          error: function error(e) {
            console.log('err');
          }
        });
      }, 1000);
      // }
    } else {
      window.open('https://accounts.dowjones.com/auth/wsjpro/login?target=http://www.wsj.com/pro/' + dynamicUrl, '_blank' // <- This is what makes it open in a new window.
      );
    }
  });
});

// Tracking Code + Smooth Scroll
var headerHeight = jQuery('header').height();

jQuery('a').not('#formModal a').on('click', trackingCode);

function trackingCode() {
  var href = jQuery(this).attr('href');
  var anchorTag = href.substr(href.indexOf('#'));

  var str = window.location.href.slice(window.location.href.indexOf('?') + 1);
  var url = window.location.href.split(/[?#]/)[0];
  var querystring = str.split('?').pop().split('#')[0];

  var baseUrl;
  var getUrl = window.location;

  var pathname = window.location.pathname;
  var pathnameParts = pathname ? pathname.split('/').filter(Boolean) : '';
  var subPage = pathnameParts ? pathnameParts.slice(1).join('/') : '';

  if (window.location.hostname == '127.0.0.1' || window.location.hostname == 'localhost') {
    if (location.pathname.length > 37) {
      baseUrl = getUrl.protocol + '//' + getUrl.host + '/' + getUrl.pathname.split('/')[1] + '/' + getUrl.pathname.split('/')[2];
    } else {
      baseUrl = url;
    }
  } else if (window.location.hostname == 'djadminstag.dowjones.com' || window.location.hostname == 'djadmin.dowjones.com') {
    if (subPage) {
      baseUrl = getUrl.protocol + '//' + getUrl.host + '/' + getUrl.pathname.split('/')[1];
    } else {
      baseUrl = url;
    }
  } else {
    if (location.pathname.substring(1)) {
      baseUrl = window.location.origin;
    } else {
      baseUrl = url;
    }
  }

  if (href && querystring) {
    if (querystring.indexOf('=') >= 0) {
      if (href.indexOf('#') < 0) {
        jQuery(this).attr('href', href + '?' + querystring);
      } else if (href.indexOf('#') >= 0) {
        jQuery(this).attr('href', baseUrl + '?' + querystring + anchorTag);
      } else {
        jQuery(this).attr('href', href + '?' + querystring);
      }
    } else if (href.indexOf('#') >= 0) {
      jQuery(this).attr('href', baseUrl + anchorTag);
    }
  }

  jQuery('html, body').not('#formModal a').animate({
    scrollTop: jQuery(this.hash).offset().top - headerHeight
  }, 800);
}

// HAMBURGER NAVIGATION

// Side Nav open/close on Hamburger click
var hamburger = document.querySelector('.hamburger');
var body = document.getElementsByTagName('body')[0];
var main = document.querySelector('.main-container');
var sideNav = document.querySelector('.nav__dropdown');

hamburger.addEventListener('click', menu);

function menu() {
  main.classList.toggle('push-main');
  sideNav.classList.toggle('show-nav');
  main.classList.toggle('pull-main');
  sideNav.classList.toggle('hide-nav');
  body.classList.toggle('fixed-position');
  hamburger.classList.toggle('is-active');
}

// Side Nav open/close on menu item click
var navItems = document.querySelectorAll('.nav__dropdown-items');
var subnavItems = document.querySelectorAll('.nav__submenu-items');

navItems.forEach(function (item) {
  item.addEventListener('click', closeSideMenu);
});

subnavItems.forEach(function (item) {
  item.addEventListener('click', closeSideMenu);
});

function closeSideMenu() {
  hamburger.classList.remove('is-active');
  main.classList.remove('push-main');
  sideNav.classList.remove('show-nav');
  body.classList.remove('fixed-position');
}

var priceTier = 0;

function showPricing() {
  jQuery('.pricing-card').hide();
  jQuery('.pricing-card:eq(' + priceTier + ')').show();
}
showPricing();

// Desktop Tier Change
jQuery('.pricing-bar__option').click(function () {
  priceTier = jQuery(this).index('.pricing-bar__option');
  showPricing();
});

//Mobile Tier Change
jQuery('.custom-option').on('click', function () {
  priceTier = jQuery(this).attr('value');
  showPricing();
});

//Desktop Active State
jQuery('.pricing-bar__option:eq(' + priceTier + ')').toggleClass('pricing-bar__option--active');
jQuery('.pricing-bar__option').on('click', function () {
  jQuery(this).addClass('pricing-bar__option--active');
  jQuery('.pricing-bar__option').not(this).removeClass('pricing-bar__option--active');
});

var selectWrapper = document.querySelector('.custom-select-wrapper');

if (selectWrapper) {
  selectWrapper.addEventListener('click', function () {
    this.querySelector('.custom-select').classList.toggle('open');
  });

  var _iteratorNormalCompletion = true;
  var _didIteratorError = false;
  var _iteratorError = undefined;

  try {
    for (var _iterator = document.querySelectorAll('.custom-option')[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
      var option = _step.value;

      option.addEventListener('click', function () {
        if (!this.classList.contains('selected')) {
          this.parentNode.querySelector('.custom-option.selected').classList.remove('selected');
          this.classList.add('selected');
          this.closest('.custom-select').querySelector('.custom-select__trigger span').textContent = this.textContent;
        }
      });
    }
  } catch (err) {
    _didIteratorError = true;
    _iteratorError = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion && _iterator.return) {
        _iterator.return();
      }
    } finally {
      if (_didIteratorError) {
        throw _iteratorError;
      }
    }
  }
}

//Append tagging code to CTA

var pricingBtns = document.querySelectorAll('.btn-pricing');

for (var i = 0, len = pricingBtns.length; i < len; i++) {
  pricingBtns[i].href += window.location.href.substring(window.location.href.lastIndexOf('/') + 1);
}

//Add Social Pixel for 1 and 2 CTA's
var firstPricingButton = allPricingButtons[0];
var secondPricingButton = allPricingButtons[1];

function firstData() {
  if (firstPricingButton.dataset.name === 'pricingtiers–pe') {
    window.lintrk('track', {
      conversion_url: 'store.wsj.com/privateequitymonthlysingle'
    });
  } else if (firstPricingButton.dataset.name === 'pricingtiers–bk') {
    window.lintrk('track', {
      conversion_url: 'store.wsj.com/bankruptcymonthlysingle'
    });
  } else if (firstPricingButton.dataset.name === 'pricingtiers–cb') {
    window.lintrk('track', {
      conversion_url: 'store.wsj.com/centralbankingmonthlysingle'
    });
  } else if (firstPricingButton.dataset.name === 'pricingtiers–vc') {
    window.lintrk('track', {
      conversion_url: 'store.wsj.com/venturecapitalmonthlysingle'
    });
  }
}

if (firstPricingButton) {
  firstPricingButton.addEventListener('click', firstData);
}

function secondData() {
  if (firstPricingButton.dataset.name === 'pricingtiers–pe') {
    window.lintrk('track', {
      conversion_url: 'store.wsj.com/privateequityannualsingle'
    });
  } else if (firstPricingButton.dataset.name === 'pricingtiers–bk') {
    window.lintrk('track', {
      conversion_url: 'store.wsj.com/bankruptcyannualsingle'
    });
  } else if (firstPricingButton.dataset.name === 'pricingtiers–cb') {
    window.lintrk('track', {
      conversion_url: 'store.wsj.com/centralbankingannualsingle'
    });
  } else if (firstPricingButton.dataset.name === 'pricingtiers–vc') {
    window.lintrk('track', {
      conversion_url: 'store.wsj.com/venturecapitalannualsingle'
    });
  }
}

if (secondPricingButton) {
  secondPricingButton.addEventListener('click', secondData);
}